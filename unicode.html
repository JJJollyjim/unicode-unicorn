<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<title>JS Unicode Thing</title>
	<script src="jquery-2.2.0.min.js"></script>
	<script src="data.js"></script>
	<script src="encode.js"></script>
	<script src="graphemes.js"></script>
	<script src="han.js"></script>
	<script src="ui.js"></script>

	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.suggestion:hover {
			background-color: #dfd;
		}
		.deletion:hover {
			background-color: #fdd;
		}
		input[type=text] {
			width: 100%;
		}
		textarea {
			width: 100%;
			font-size: 30pt;
		}
		pre {
			white-space: pre-line;
			word-break: normal;
		}
		.fixed {
			position: fixed;
			background-color: white;
			width: calc(100% - 30px);
		}
		.spacer {
			background-color: white;
		}

	</style>
</head>
<body>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<div style="width: 100%; height: 15px; position: fixed; background-color: white"></div>
	<div style="padding: 15px">
		<div class="fixed" data-spacer-id="nav-spacer">
			<p>
				<textarea id="output"></textarea>
			</p>

			<!-- Nav tabs -->
			<ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active">
					<a href="#search" aria-controls="search" role="tab" data-toggle="tab">Search and Insert</a>
				</li>
				<li role="presentation">
					<a href="#stats" aria-controls="stats" role="tab" data-toggle="tab">Text Info</a>
				</li>
				<li role="presentation">
					<a href="#codepoints" aria-controls="codepoints" role="tab" data-toggle="tab">List of Codepoints</a>
				</li>
				<li role="presentation">
					<a href="#encode" aria-controls="encode" role="tab" data-toggle="tab">Encoded Text</a>
				</li>
				<li role="presentation">
					<a href="#normalization" aria-controls="normalization" role="tab" data-toggle="tab">Unicode Normalization</a>
				</li>
			</ul>
		</div>

		<div id="nav-spacer" class="spacer"></div>

		<!-- Tab panes -->
		<div class="tab-content">
			<div role="tabpanel" class="tab-pane active" id="search">
				<div class="fixed" data-spacer-id="input-spacer">
					<input type="text" id="input" placeholder="Search for a character...">
				</div>
				<div id="input-spacer" class="spacer"></div>
				<table class="table table-striped" id="searchResults"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="stats">
				<p id="info">
					String:
					<br>
					<div id="string"></div>
					<br>
					Extended grapheme clusters: <span id="extendedGraphemeClusters">0</span>
					<br>
					Legacy grapheme clusters: <span id="legacyGraphemeClusters">0</span>
					<br>
					Codepoints: <span id="numCodepoints">0</span>
					<br>
					UTF-16 code units: <span id="numUtf16CodeUnits">0</span>
					<br>
					UTF-8 code units: <span id="numUtf8CodeUnits">0</span>
					<br>
					Use this URL to share the unicode sequence: <a id="url" style="word-break: break-all;"></a>
					<br>
				</p>
			</div>
			<div role="tabpanel" class="tab-pane" id="codepoints">
				<table id="codepointlist" class="table table-striped"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="encode">
				<p>
					<select id="byteOrderMark">
						<option>Use a byte order mark (U+FEFF)</option>
						<option selected="selected">Don't use a byte order mark</option>
					</select>
					<br>
					<select id="outputEncoding">
						<option>ASCII</option>
						<option>ISO 8859-1 ("Latin 1")</option>
						<option selected="selected">Unicode UTF-8</option>
						<option>Unicode UTF-16 (16-bit code units)</option>
						<option>Unicode UTF-16 BE (8-bit code units)</option>
						<option>Unicode UTF-16 LE (8-bit code units)</option>
						<option>UCS-2 (16-bit code units)</option>
						<option>UCS-2 BE (8-bit code units)</option>
						<option>UCS-2 LE (8-bit code units)</option>
						<option>Unicode UTF-32 (32-bit code units)</option>
						<option>Unicode UTF-32 BE (8-bit code units)</option>
						<option>Unicode UTF-32 LE (8-bit code units)</option>
					</select>
					<br>
					<select id="outputFormat">
						<option>Binary (Unpadded, Unprefixed)</option>
						<option>Binary (Padded, Unprefixed)</option>
						<option>Binary (Unpadded, Prefixed with '0b')</option>
						<option>Binary (Padded, Prefixed with '0b')</option>
						<option>Binary (Unpadded, Prefixed with '\b')</option>
						<option>Binary (Padded, Prefixed with '\b')</option>
						<option>Octal (Unprefixed)</option>
						<option>Octal (Prefixed with '0o')</option>
						<option>Octal (Prefixed with '0')</option>
						<option>Octal (Prefixed with '\o')</option>
						<option>Decimal</option>
						<option>Hexadecimal (Unpadded, Unprefixed)</option>
						<option>Hexadecimal (Unpadded, Prefixed with '0x')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '0X')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\x')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\X')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\u')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\U')</option>
						<option>Hexadecimal (Unpadded, Prefixed with 'U+')</option>
						<option>Hexadecimal (Padded, Unprefixed)</option>
						<option selected="selected">Hexadecimal (Padded, Prefixed with '0x')</option>
						<option>Hexadecimal (Padded, Prefixed with '0X')</option>
						<option>Hexadecimal (Padded, Prefixed with '\x')</option>
						<option>Hexadecimal (Padded, Prefixed with '\X')</option>
						<option>Hexadecimal (Padded, Prefixed with '\u')</option>
						<option>Hexadecimal (Padded, Prefixed with '\U')</option>
						<option>Hexadecimal (Padded, Prefixed with 'U+')</option>
					</select>
					<br>
					<select id="outputJoiner">
						<option>Unseparated</option>
						<option>Separated using spaces</option>
						<option>Separated using commas</option>
						<option selected="selected">Separated using commas and spaces</option>
						<option>Separated using semicolons</option>
						<option>Separated using semicolons and spaces</option>
						<option>Separated using linebreaks</option>
						<option>Separated using commas and linebreaks</option>
					</select>
				</p>
				<p>
					<pre id="encodedOutput"></pre>
				</p>
			</div>
			<div role="tabpanel" class="tab-pane" id="normalization">
				<p>
					Click on one of these buttons to perform Unicode normalization on the string:
					<br>
					<br>
					<input type="button" onclick="normalizeString('NFD')" value="NFD (Normalization Form D: Canonical Decomposition)">
					<br>
					<input type="button" onclick="normalizeString('NFC')" value="NFC (Normalization Form C: Canonical Decomposition, followed by Canonical Composition)">
					<br>
					<input type="button" onclick="normalizeString('NFKD')" value="NFKD (Normalization Form KD: Compatibility Decomposition)">
					<br>
					<input type="button" onclick="normalizeString('NFKC')" value="NFKC (Normalization Form KC: Compatibility Decomposition, followed by Canonical Composition)">
				</p>
			</div>
		</div>
	</div>
	<script>

		function output(codepoint) {
			$('#output').val($('#output').val() + ctos([codepoint]));
			updateInfo();
		}

		function updateSuggestions() {
			var input = $('#input').val();
			var results = searchCodepoints(input);
			renderCodepointsInTable(results, 'searchResults', [{displayName: 'Insert', functionName: 'output'}]);
		}

		function normalizeString(form) {
			if (!String.prototype.normalize) {
				alert('Your browser currently does not support string normalization.');
				return;
			}
			$('#output').val($('#output').val().normalize(form));
			updateInfo();
		}

		function uiState() {
			return $('#output').val()
				+ $('#outputEncoding option:selected').text()
				+ $('#outputFormat option:selected').text()
				+ $('#outputJoiner option:selected').text()
				+ $('#byteOrderMark option:selected').text();
		}

		window.prevUIState = '';
		function updateInfo() {
			var input = $('#output').val();
			if (uiState() == window.prevUIState)
				return;
			var codepoints = stoc(input);

			$('#extendedGraphemeClusters').text(countGraphemesForCodepoints(codepoints, true));
			$('#legacyGraphemeClusters').text(countGraphemesForCodepoints(codepoints, false));
			$('#numCodepoints').text(codepoints.length);
			$('#numUtf16CodeUnits').text(input.length);

			var numUtf8CodeUnits = 0;
			for (var i in codepoints) {
				var c = codepoints[i];
				if (c < 0x80)
					numUtf8CodeUnits += 1;
				else if (c < 0x800)
					numUtf8CodeUnits += 2;
				else if (c < 0x10000)
					numUtf8CodeUnits += 3;
				else if (c < 0x10FFFF)
					numUtf8CodeUnits += 4;
				else
					numUtf8CodeUnits = 0;
			}
			$('#numUtf8CodeUnits').text(numUtf8CodeUnits);
			$('#string').html(escapeHtml($('#output').val()).replace('\n', '<br>'));

			renderCodepointsInTable(codepoints, 'codepointlist', [{
				displayName: 'Delete',
				functionName: 'deleteAtIndex'
			}, {
				displayName: 'Move up',
				functionName: 'moveUp',
				require: function(i, length) { return i != 0; }
			}, {
				displayName: 'Move down',
				functionName: 'moveDown',
				require: function(i, length) { return i != length - 1; }
			}]);

			var url = window.location.href.indexOf('?') == -1
				? window.location.href
				: window.location.href.substring(0, window.location.href.indexOf('?'));
			if (codepoints.length > 0)
				url += '?c=' + codepoints.join(',');
			$('#url').text(url);
			$('#url').attr('href', url);

			$('#encodedOutput').html(encodeOutput(
				$('#byteOrderMark option:selected').text(),
				$('#outputEncoding option:selected').text(),
				$('#outputFormat option:selected').text(),
				$('#outputJoiner option:selected').text(),
				codepoints
			));

			window.prevUIState = uiState();
		}

		function deleteAtIndex(codepoint, index) {
			var input = $('#output').val();
			var codepoints = stoc(input);
			codepoints.splice(index, 1);
			var output = ctos(codepoints);
			$('#output').val(output);
			updateInfo();
		}

		function moveUp(codepoint, index) {
			var input = $('#output').val();
			var codepoints = stoc(input);
			var c = codepoints[index];
			codepoints[index] = codepoints[index-1];
			codepoints[index-1] = c;
			var output = ctos(codepoints);
			$('#output').val(output);
			updateInfo();
		}

		function moveDown(codepoint, index) {
			var input = $('#output').val();
			var codepoints = stoc(input);
			var c = codepoints[index];
			codepoints[index] = codepoints[index+1];
			codepoints[index+1] = c;
			var output = ctos(codepoints);
			$('#output').val(output);
			updateInfo();
		}

		function initData(completion) {
			var completeCount = 0;
			var onComplete = function() {
				++completeCount;
				if (completeCount == 3)
					completion();
			}
			initHanData(onComplete);
			initGraphemeData(onComplete);
			initUnicodeData(onComplete);
		}

		function updateSpacerHeights() {
			$('.fixed').each(function(i, e) {
				var spacerId = $(e).attr('data-spacer-id');
				var spacer = $('#' + spacerId);
				if (spacer.attr('data-extra-height'))
					var extraHeight = parseFloat($(spacer).attr('data-extra-height'));
				else
					var extraHeight = 0;
				spacer.height($(e).height() + extraHeight);
			});
		}

		var loaded = false;
		$(document).ready(function() {
			if (loaded)
				return;
			loaded = true;
			var args = window.location.search.substring(1).split('&');
			for (var i in args) {
				var arg = args[i].split('=');
				if (arg[0] == 'c') {
					$('#output').val(ctos(arg[1].split(',')));
				}
			}
			updateSpacerHeights();
			initData(function() {
				updateInfo();
				updateSuggestions();
				$('#input').on('keyup', function(e) {
					if (e.keyCode == 13) {
						var input = $('#input').val();
						if (isNaN(parseInt(input.replace('U+', '0x')))) {
							document.body.style.backgroundColor = '#fdd';
							window.setTimeout(function() {
								document.body.style.backgroundColor = '#fff';
							}, 1000);
						} else {
							output(parseInt(input.replace('U+', '0x')));
							updateInfo();
							$('#input').val('');
						}
					}
					updateSuggestions();
				});
				$('#output').on('keyup', function() {
					updateInfo();
				});
				$('select').change(function() {
					updateInfo();
				});
				window.setInterval(function() {
					updateInfo();
					updateSpacerHeights();
				}, 1000);
				$('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
					updateSpacerHeights();
				})
			});
		});

	</script>
</body>
</html>