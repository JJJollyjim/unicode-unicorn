<html>
<head>
	<title>JS Unicode Thing</title>
	<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
	<script src="data.js"></script>
	<script src="encode.js"></script>
	<script src="graphemes.js"></script>
	<style>
		.suggestion:hover {
			background-color: #dfd;
		}
		.deletion:hover {
			background-color: #fdd;
		}
		input[type=text] {
			width: 100%;
		}
	</style>
</head>
<body>
<input type="button" id="help" value="?">
<input type="button" onclick="normalizeString('NFC')" value="NFC">
<input type="button" onclick="normalizeString('NFD')" value="NFD">
<input type="button" onclick="normalizeString('NFKC')" value="NFKC">
<input type="button" onclick="normalizeString('NFKD')" value="NFKD">
<br>
<input type="text" id="output">
<br>
<p id="info">
	String: <span id="string"></span>
	<br>
	Extended grapheme clusters: <span id="extendedGraphemeClusters">0</span>
	<br>
	Legacy grapheme clusters: <span id="legacyGraphemeClusters">0</span>
	<br>
	Codepoints: <span id="numCodepoints">0</span>
	<br>
	UTF-16 code units: <span id="numUtf16CodeUnits">0</span>
	<br>
	UTF-8 code units: <span id="numUtf8CodeUnits">0</span>
	<br>
	Use this URL to share the unicode sequence: <a id="url"></a>
	<br>
	<p id="codepointlist"></p>
</p>
<input type="text" id="input" placeholder="Search for a character...">
<div id="suggestions"></div>
<script>

function output(codepoint) {
	$('#output').val($('#output').val() + ctos([codepoint]));
	updateInfo();
}

$('#suggestions').on('click', '.suggestion', function(e) {
	var text = e.currentTarget.textContent;
	if (text.startsWith('U+')) {
		output(parseInt(text.replace('U+', '0x')));
	}
});

function updateSuggestions() {
	var input = $('#input').val();
	var suggestions = searchCodepoints(input);
	if (suggestions.length == 0) {
		$('#suggestions').html('');
		return;
	}
	if (suggestions.length >= 200)
		suggestions.push('...');
	for (var i in suggestions)
		suggestions[i] = escapeHtml(suggestions[i]);
	$('#suggestions').html('<div class="suggestion">' + suggestions.join('</div><div class="suggestion">') + '</div>');
}

function normalizeString(form) {
	if (!String.prototype.normalize) {
		alert('Your browser does not yet support string normalization');
		return;
	}
	$('#output').val($('#output').val().normalize(form));
	updateInfo();
}

window.prevInput = '';
function updateInfo() {
	var input = $('#output').val();
	if (input == window.prevInput)
		return;
	var codepoints = stoc(input);

	$('#extendedGraphemeClusters').text(countGraphemesForCodepoints(codepoints, true));
	$('#legacyGraphemeClusters').text(countGraphemesForCodepoints(codepoints, false));
	$('#numCodepoints').text(codepoints.length);
	$('#numUtf16CodeUnits').text(input.length);

	var numUtf8CodeUnits = 0;
	for (var i in codepoints) {
		var c = codepoints[i];
		if (c < 0x80)
			numUtf8CodeUnits += 1;
		else if (c < 0x800)
			numUtf8CodeUnits += 2;
		else if (c < 0x10000)
			numUtf8CodeUnits += 3;
		else if (c < 0x10FFFF)
			numUtf8CodeUnits += 4;
		else
			numUtf8CodeUnits = 0;
	}
	$('#numUtf8CodeUnits').text(numUtf8CodeUnits);
	$('#string').text(escapeHtml($('#output').val()));

	var codepointinfo = '';
	for (var i in codepoints) {
		codepointinfo += '<div class="deletion" onclick="deleteAtIndex(' + i + ');">';
		codepointinfo += escapeHtml(getUnicodeData(codepoints[i]));
		codepointinfo += '</div>';
	}
	$('#codepointlist').html(codepointinfo);
	var url = window.location.href.indexOf('?') == -1
		? window.location.href
		: window.location.href.substring(0, window.location.href.indexOf('?'));
	url += '?c=' + codepoints.join(',');
	$('#url').text(url);
	$('#url').attr('href', url);
	window.prevInput = input;
}

function deleteAtIndex(index) {
	var input = $('#output').val();
	var codepoints = stoc(input);
	codepoints.splice(index, 1);
	var output = ctos(codepoints);
	$('#output').val(output);
	updateInfo();
}

var loaded = false;
$(document).ready(function() {
	if (loaded)
		return;
	loaded = true;
	var args = window.location.search.substring(1).split('&');
	for (var i in args) {
		var arg = args[i].split('=');
		if (arg[0] == 'c') {
			$('#output').val(ctos(arg[1].split(',')));
		}
	}
	initUnicodeData(function() {
		initGraphemeData(function() {
			updateInfo();
			$('#input').on('keyup', function(e) {
				if (e.keyCode == 13) {
					var input = $('#input').val();
					if (isNaN(parseInt(input.replace('U+', '0x')))) {
						document.body.style.backgroundColor = '#fdd';
						window.setTimeout(function() {
							document.body.style.backgroundColor = '#fff';
						}, 1000);
					} else {
						output(parseInt(input.replace('U+', '0x')));
						updateInfo();
						$('#input').val('');
					}
				}
				updateSuggestions();
			});
			$('#output').on('keyup', function(e) {
				updateInfo();
			});
			window.setInterval(function() {
				updateInfo();
			}, 1000);
		});
	});
});

$('#help').on('click', function() {
	alert('JS Unicode Thing:\n\nThis tool allows you to create unicode strings. Enter codepoints either as a number (123), as hex (0x123) or by clicking on one of the autocomplete suggestions.\nNote that Chrome\'s unicode handling of nontrivial combining characters is a bit wonky. I\'ve found Safari to work quite well. Firefox is also a bit broken for some character combinations.');
});

</script>
</body>
</html>