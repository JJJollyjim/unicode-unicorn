<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<title>JS Unicode Thing</title>

	<link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/stylesheet.css" rel="stylesheet">
</head>
<body>
	<script src="libs/jquery-2.2.0.min.js"></script>
	<script src="libs/bootstrap/js/bootstrap.min.js"></script>
	<script src="libs/he.js"></script>
	<script src="libs/jszip.min.js"></script>
	<script src="libs/jszip-utils.min.js"></script>
	<script src="libs/punycode.min.js"></script>
	<script src="libs/randomColor.js"></script>
	<script src="libs/utf8.js"></script>

	<script src="js/ajax.js"></script>
	<script src="js/blocks.js"></script>
	<script src="js/data.js"></script>
	<script src="js/encode.js"></script>
	<script src="js/graphemes.js"></script>
	<script src="js/han.js"></script>
	<script src="js/languages.js"></script>
	<script src="js/search.js"></script>
	<script src="js/tests.js"></script>
	<script src="js/ui.js"></script>

	<div style="width: 100%; height: 30px; position: fixed; background-color: white"></div>
	<div style="padding: 15px">
		<div class="fixed" data-spacer-id="nav-spacer">
			<p>
				<textarea id="output"></textarea>
			</p>

			<!-- Nav tabs -->
			<ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active">
					<a href="#search" aria-controls="search" role="tab" data-toggle="tab">Search and Insert</a>
				</li>
				<li role="presentation">
					<a href="#stats" aria-controls="stats" role="tab" data-toggle="tab">Text Info</a>
				</li>
				<li role="presentation">
					<a href="#codepoints" aria-controls="codepoints" role="tab" data-toggle="tab">List of Codepoints</a>
				</li>
				<li role="presentation">
					<a href="#encode" aria-controls="encode" role="tab" data-toggle="tab">Encodings</a>
				</li>
				<li role="presentation">
					<a href="#mojibake" aria-controls="mojibake" role="tab" data-toggle="tab">文字化け</a>
				</li>
				<li role="presentation">
					<a href="#normalization" aria-controls="normalization" role="tab" data-toggle="tab">Unicode Normalization</a>
				</li>
				<li role="presentation">
					<a href="#codepages" aria-controls="codepages" role="tab" data-toggle="tab">View Codepages</a>
				</li>
				<li role="presentation">
					<a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Help &amp; Settings</a>
				</li>
			</ul>
		</div>

		<div id="nav-spacer" class="spacer"></div>

		<!-- Tab panes -->
		<div class="tab-content">
			<div role="tabpanel" class="tab-pane active" id="search">
				<div class="fixed" data-spacer-id="input-spacer">
					<input type="text" id="input" placeholder="Search for a character... (use commas to separate terms)">
				</div>
				<div id="input-spacer" class="spacer"></div>
				<table class="table table-striped" id="searchResults"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="stats">
				<p>
					String:
				</p>
				<div id="string"></div>
				<p>
					<br>
					Extended grapheme clusters: <span id="extendedGraphemeClusters">0</span>
					<br>
					Legacy grapheme clusters: <span id="legacyGraphemeClusters">0</span>
					<br>
					Codepoints: <span id="numCodepoints">0</span>
					<br>
					UTF-16 code units: <span id="numUtf16CodeUnits">0</span>
					<br>
					UTF-16 bytes: <span id="numUtf16Bytes">0</span>
					<br>
					UTF-8 code units/bytes: <span id="numUtf8CodeUnits">0</span>
				</p>
			</div>
			<div role="tabpanel" class="tab-pane" id="codepoints">
				<table id="codepointlist" class="table table-striped"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="encode">
				<p>
					<select id="byteOrderMark">
						<option>Use a byte order mark (U+FEFF)</option>
						<option selected="selected">Don't use a byte order mark</option>
					</select>
					<br>
					<select id="outputEncoding">
					</select>
					<br>
					<select id="outputFormat">
						<option>Binary (Unpadded, Unprefixed)</option>
						<option>Binary (Padded, Unprefixed)</option>
						<option>Binary (Unpadded, Prefixed with '0b')</option>
						<option>Binary (Padded, Prefixed with '0b')</option>
						<option>Binary (Unpadded, Prefixed with '\b')</option>
						<option>Binary (Padded, Prefixed with '\b')</option>
						<option>Octal (Unprefixed)</option>
						<option>Octal (Prefixed with '0o')</option>
						<option>Octal (Prefixed with '0')</option>
						<option>Octal (Prefixed with '\o')</option>
						<option>Decimal</option>
						<option>Hexadecimal (Unpadded, Unprefixed)</option>
						<option>Hexadecimal (Unpadded, Prefixed with '0x')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '0X')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\x')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\X')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\u')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\U')</option>
						<option>Hexadecimal (Unpadded, Prefixed with 'U+')</option>
						<option>Hexadecimal (Padded, Unprefixed)</option>
						<option selected="selected">Hexadecimal (Padded, Prefixed with '0x')</option>
						<option>Hexadecimal (Padded, Prefixed with '0X')</option>
						<option>Hexadecimal (Padded, Prefixed with '\x')</option>
						<option>Hexadecimal (Padded, Prefixed with '\X')</option>
						<option>Hexadecimal (Padded, Prefixed with '\u')</option>
						<option>Hexadecimal (Padded, Prefixed with '\U')</option>
						<option>Hexadecimal (Padded, Prefixed with 'U+')</option>
					</select>
					<br>
					<select id="outputJoiner">
						<option>Unseparated</option>
						<option>Separated using spaces</option>
						<option>Separated using commas</option>
						<option selected="selected">Separated using commas and spaces</option>
						<option>Separated using semicolons</option>
						<option>Separated using semicolons and spaces</option>
						<option>Separated using linebreaks</option>
						<option>Separated using commas and linebreaks</option>
					</select>
				</p>
				<pre id="encodedOutput"></pre>
				<textarea id="encodedInput" placeholder="Input to decode using above settings"></textarea>
				<table class="table table-striped" id="decodedCodepoints"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="mojibake">
				<pre id="mojibakeOutput"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="normalization">
				<p>
					Click on one of these buttons to perform Unicode normalization on the string:
					<br>
					<br>
					<input type="button" onclick="normalizeString('NFD')" value="NFD (Normalization Form D: Canonical Decomposition)">
					<br>
					<input type="button" onclick="normalizeString('NFC')" value="NFC (Normalization Form C: Canonical Decomposition, followed by Canonical Composition)">
					<br>
					<input type="button" onclick="normalizeString('NFKD')" value="NFKD (Normalization Form KD: Compatibility Decomposition)">
					<br>
					<input type="button" onclick="normalizeString('NFKC')" value="NFKC (Normalization Form KC: Compatibility Decomposition, followed by Canonical Composition)">
				</p>
			</div>
			<div role="tabpanel" class="tab-pane" id="codepages">
				<select id="codepageEncoding">
				</select>
				<table class="table" id="codepage"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="settings">
				<b>Internal String:</b>
				<p>
					<input type="checkbox" id="useInternalString"> Use internal string<br>
					Use internal memory instead of above textarea for storing the Unicode string. This prevents browsers from doing some automatic conversions, including line ending conversions.
				</p>
				<b>Search syntax:</b>
				<p>
					Use commas to separate multiple terms.<br>
					All searches are case-insensitive.<br>
					By default, all visible character properties are searched, but you can use this syntax to search for specific character properties:
					<!-- no indentation as this would be rendered in the DOM -->
					<pre>U+0030
cp:48
name:Digit three (aliases are also supported)
block:Basic Latin
script:Latin
category:Decimal Number
Water (search for CJK ideograph meaning)
kun:mizu
on:sui
mandarin:shuǐ</pre>
				</p>
				<b>Unit Tests</b>
				<p>
					<input type="button" onclick="runTests()" value="Run Unit Tests">
				</p>
				<b>Language, Script and Region Settings:</b>
				<p>
					The shapes of some characters may change depending on your browser's language. For example, Han characters have different shapes in Chinese and Japanese. You can overwrite your browser's language by choosing the correct language settings here. Alternatively, you can type a valid language code into the textbox below. See <a target="_blank" href="https://www.w3.org/International/articles/language-tags/">here</a> for more information.<br>
					<input type="button" id="showRareLanguages" value="Show rare languages (slows down the browser)"><br>
					Language: <select id="languageList"></select><br>
					Script: <select id="scriptList"></select><br>
					Region: <select id="regionList"></select><br>
					Variant: <select id="variantList"></select><br>
					Code: <input type="text" id="languageCode" placeholder="Language code (e.g. en, en-US, zh-Hant)">
				</p>
				<p>
					<a onclick="$('#licenses-modal').modal('show');" style="cursor: pointer;">Third-Party Licenses</a>
				</p>
			</div>
		</div>
	</div>
	<div class="modal fade" data-backdrop="static" data-keyboard="false" id="loadingModal" role="dialog">
		<div style="height: 20%">
		</div>
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Loading Unicode Data Files...</h4>
				</div>
				<div class="modal-body">
					<p>This may take a few seconds.</p>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="codepoint-detail" role="dialog">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Info for codepoint U+<span id="detail-codepoint-hex">0000</span> (Decimal: <span id="detail-codepoint-decimal"></span>)</h4>
				</div>
				<div class="modal-body">
					<p>Name: <span id="detail-name"></span></p>
					<p>Character: <span id="detail-character"></span></p>
					<p>General Character Category: <span id="detail-category"></span></p>
					<p>Block: <span id="detail-block"></span></p>
					<p>Script: <span id="detail-script"></span></p>
					<p id="detail-aliases">Aliases: <span id="detail-aliases-list"></span></p>
					<p id="detail-meaning">Meaning: <span id="detail-meaning-content"></span></p>
					<p id="detail-mandarin">Mandarin: <span id="detail-mandarin-content"></span></p>
					<p id="detail-kun">Kun: <span id="detail-kun-content"></span></p>
					<p id="detail-on">On: <span id="detail-on-content"></span></p>
					<p id="detail-variation-sequences">Variation sequences:<br><table class="table" id="detail-variation-sequences-content"></table></p>
					<pre id="detail-encoding-outputs"></pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="licenses-modal" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Third-Party Licenses</h4>
				</div>
				<div class="modal-body">
					<pre id="licenses-text">
					</pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="unit-tests-modal" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Unit test results</h4>
				</div>
				<div class="modal-body">
					<pre id="unit-tests-text">
					</pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		global_useInternalString = false;
		global_internalString = '';
		function getStr() {
			return global_useInternalString ? global_internalString : $('#output').val();
		}

		function setStr(str) {
			for (var i = 0; i < str.length; ++i) {
				if (str.charCodeAt(i) < 0 || str.charCodeAt(i) > 0x10FFFF) {
					str.splice(i, 1); // remove element at i
				}
			}
			global_internalString = str;
			$('#output').val(str);
		}

		function output(codepoint) {
			setStr(getStr() + ctos([codepoint]));
			updateInfo();
		}

		function updateSuggestions() {
			var input = $('#input').val();
			var results = searchCodepoints(input);
			renderCodepointsInTable(
				results,
				'searchResults',
				[{displayName: 'Insert', functionName: 'output'}]
			);
		}

		function normalizeString(form) {
			if (!String.prototype.normalize) {
				alert('Your browser currently does not support string normalization.');
				return;
			}

			setStr(getStr().normalize(form));
			updateInfo();
		}

		function uiState() {
			return $('#output').val()
				+ global_internalString
				+ $('#encodedInput').val()
				+ $('#languageCode').val()
				+ $('#useInternalString').is(':checked')
				+ $('#outputEncoding option:selected').text()
				+ $('#outputFormat option:selected').text()
				+ $('#outputJoiner option:selected').text()
				+ $('#byteOrderMark option:selected').text()
				+ $('#codepageEncoding option:selected').text()
				+ $('#languageList option:selected').text()
				+ $('#scriptList option:selected').text()
				+ $('#regionList option:selected').text()
				+ $('#variantList option:selected').text();
		}

		prevUIState = '';
		function updateInfo() {
			if (uiState() == prevUIState)
				return;
			actualUpdateInfo();
			prevUIState = uiState();
		}
		function actualUpdateInfo() {
			global_useInternalString = $('#useInternalString').is(':checked');
			setStr(getStr());

			var input = getStr();
			var codepoints = stoc(input);

			if ($('#mojibake').hasClass('active')) {
				var mojibakeOutputs = [];
				$('#outputEncoding option').each(function(i, e) {
					var encoding1Name = $(e).text();
					if (global_encodings[encoding1Name].type == 'text function')
						return;
					var encodedString = encodeOutput(
						'Don\'t use a byte order mark',
						encoding1Name,
						'Decimal',
						'Separated using commas and spaces',
						codepoints);
					if (encodedString.startsWith('<'))
						return;
					$('#outputEncoding option').each(function(j, f) {
						if (i == j)
							return;
						var encoding2Name = $(f).text();
						if (global_encodings[encoding2Name].type == 'text function')
							return;
						var decodedString = decodeOutput(
							'Don\'t use a byte order mark',
							encoding2Name,
							'Decimal',
							'Separated using commas and spaces',
							encodedString);
						if (!decodedString)
							return;
						for (var k = 0; k < mojibakeOutputs.length; ++k) {
							if (mojibakeOutputs[k].text == ctos(decodedString))
								return;
						}
						mojibakeOutputs.push({
							encoding1Name: encoding1Name,
							encoding2Name: encoding2Name,
							text: ctos(decodedString)
						});
					});
				});
				var mojibakeOutputStr = '';
				var lastEncoding1 = '';
				for (var i = 0; i < mojibakeOutputs.length; ++i) {
					var o = mojibakeOutputs[i];
					if (o.encoding1Name != lastEncoding1) {
						lastEncoding1 = o.encoding1Name;
						mojibakeOutputStr += 'Assuming the input was erroneously interpreted as ' + o.encoding1Name + ':<br>';
					}
					mojibakeOutputStr += '    If the original encoding was ' + o.encoding2Name + ':<br>        ' + mojibakeOutputs[i].text + '<br>';
				}
				$('#mojibakeOutput').html(mojibakeOutputStr);
			}

			updateRenderedCodepage();

			$('#extendedGraphemeClusters').text(countGraphemesForCodepoints(codepoints, true));
			$('#legacyGraphemeClusters').text(countGraphemesForCodepoints(codepoints, false));
			$('#numCodepoints').text(codepoints.length);
			$('#numUtf16CodeUnits').text(input.length);
			$('#numUtf16Bytes').text(input.length * 2);
			$('#numUtf8CodeUnits').text(ctou8(codepoints).length);
			$('#string').html(escapeHtml(getStr()).replace(/\n/g, '<br>'));

			renderCodepointsInTable(codepoints, 'codepointlist', [{
				displayName: 'Delete',
				functionName: 'deleteAtIndex'
			}, {
				displayName: 'Move up',
				functionName: 'moveUp',
				require: function(i, length) { return i != 0; }
			}, {
				displayName: 'Move down',
				functionName: 'moveDown',
				require: function(i, length) { return i != length - 1; }
			}]);

			var url = location.href.indexOf('?') == -1
				? location.href
				: location.href.substring(0, location.href.indexOf('?'));
			if (codepoints.length > 0)
				url += '?c=' + codepoints.join(',');
			history.replaceState({}, '', url);

			$('#encodedOutput').html(encodeOutput(
				$('#byteOrderMark option:selected').text(),
				$('#outputEncoding option:selected').text(),
				$('#outputFormat option:selected').text(),
				$('#outputJoiner option:selected').text(),
				codepoints
			));

			var decodedOutput = decodeOutput(
				$('#byteOrderMark option:selected').text(),
				$('#outputEncoding option:selected').text(),
				$('#outputFormat option:selected').text(),
				$('#outputJoiner option:selected').text(),
				$('#encodedInput').val()
			);
			if (decodedOutput)
				renderCodepointsInTable(
					decodedOutput,
					'decodedCodepoints',
					[{displayName: 'Insert', functionName: 'output'}]);

			var lang = '';
			var textboxCode = $('#languageCode').val();
			var dropdownCode = '';
			var langComponentStrings = [
				$('#languageList option:selected').attr('data-code'),
				$('#scriptList option:selected').attr('data-code'),
				$('#regionList option:selected').attr('data-code'),
				$('#variantList option:selected').attr('data-code')
			];
			for (var i = 0; i < langComponentStrings.length; ++i) {
				var component = langComponentStrings[i];
				if (!component)
					continue;
				if (dropdownCode != '')
					dropdownCode += '-';
				dropdownCode += component;
			}
			// valid states:
			//   everything enabled, textboxCode and dropdownCode empty
			//   dropdownCode non-empty: textboxCode set to dropdownCode, textbox disabled
			//   dropdownCode empty: dropdown disabled

			if ($('#languageCode')[0].hasAttribute('disabled')) {
				$('#languageCode').val(''); // occurs when dropdownCode is reset to blank
			}
				
			if (textboxCode == '' && dropdownCode == '') {
				$('#languageCode').removeAttr('disabled');
				$('#languageList').removeAttr('disabled');
				$('#scriptList').removeAttr('disabled');
				$('#regionList').removeAttr('disabled');
				$('#variantList').removeAttr('disabled');
				lang = '';
			} else if (textboxCode == '' && dropdownCode != '') {
				$('#languageCode').attr('disabled', 'disabled');
				$('#languageList').removeAttr('disabled');
				$('#scriptList').removeAttr('disabled');
				$('#regionList').removeAttr('disabled');
				$('#variantList').removeAttr('disabled');
				lang = dropdownCode;
				$('#languageCode').val(lang);
			} else if (textboxCode != '' && dropdownCode == '') {
				$('#languageCode').removeAttr('disabled');
				$('#languageList').attr('disabled', 'disabled');
				$('#scriptList').attr('disabled', 'disabled');
				$('#regionList').attr('disabled', 'disabled');
				$('#variantList').attr('disabled', 'disabled');
				lang = textboxCode;
			} else {
				if ($('#languageCode')[0].hasAttribute('disabled')) {
					lang = dropdownCode;
					$('#languageCode').val(lang);
				} else {
					lang = textboxCode;
				}
			}
			
			$('html').attr('lang', lang);
			$('html').attr('xml:lang', lang);
		}

		function deleteAtIndex(codepoint, index) {
			var input = getStr();
			var codepoints = stoc(input);
			codepoints.splice(index, 1);
			var output = ctos(codepoints);
			setStr(output);
			updateInfo();
		}

		function moveUp(codepoint, index) {
			var input = getStr();
			var codepoints = stoc(input);
			var c = codepoints[index];
			codepoints[index] = codepoints[index-1];
			codepoints[index-1] = c;
			var output = ctos(codepoints);
			setStr(output);
			updateInfo();
		}

		function moveDown(codepoint, index) {
			var input = getStr();
			var codepoints = stoc(input);
			var c = codepoints[index];
			codepoints[index] = codepoints[index+1];
			codepoints[index+1] = c;
			var output = ctos(codepoints);
			setStr(output);
			updateInfo();
		}

		function initLicenseInfo(completion) {
			requestAsync('data/licenses.html', function(lines) {
				$('#licenses-text').html(lines.join('\n'));
				completion();
			});
		}

		function initData(completion) {
			loadUnicodeData(function() {
				callMultipleAsync([
					initializeMappings,
					initHanData,
					initGraphemeData,
					initUnicodeData,
					initGeneralCategoryNames,
					initAliasData,
					initBlockData,
					initHangulSyllableTypes,
					initShortJamoNames,
					initScriptData,
					initLicenseInfo,
					initLanguageData], function() {
						deleteUnicodeData();
						completion();
					});
			});
		}

		function updateSpacerHeights() {
			$('.fixed').each(function(i, e) {
				var spacerId = $(e).attr('data-spacer-id');
				var spacer = $('#' + spacerId);
				if (spacer.attr('data-extra-height'))
					var extraHeight = parseFloat($(spacer).attr('data-extra-height'));
				else
					var extraHeight = 0;
				spacer.height($(e).height() + extraHeight);
			});
		}

		var loaded = false;
		$(document).ready(function() {
			if (loaded)
				return;
			loaded = true;
			window.onpopstate = function() {
				var args = location.search.substring(1).split('&');
				for (var i = 0; i < args.length; ++i) {
					var arg = args[i].split('=');
					if (arg[0] == 'c') {
						setStr(ctos(arg[1].split(',')));
					}
				}
			};
			window.onpopstate();
			$('#loadingModal').modal('show');
			updateSpacerHeights();
			var startTime = new Date();
			initData(function() {
				initializeSearchStrings();
				var loadDuration = new Date() - startTime; // in ms
				setTimeout(function() {
					updateInfo();
					updateSuggestions();
					$('#input').on('keyup', function(e) {
						if (e.keyCode == 13) {
							var input = $('#input').val();
							if (isNaN(parseInt(input.replace('U+', '0x')))) {
								document.body.style.backgroundColor = '#fdd';
								setTimeout(function() {
									document.body.style.backgroundColor = '#fff';
								}, 1000);
							} else {
								output(parseInt(input.replace('U+', '0x')));
								updateInfo();
								$('#input').val('');
							}
						}
						updateSuggestions();
					});
					$('#output').on('keyup', function() {
						updateInfo();
					});
					$('select').change(function() {
						updateInfo();
					});
					setInterval(function() {
						updateInfo();
						updateSpacerHeights();
					}, 1000);
					$('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
						updateSpacerHeights();
						actualUpdateInfo();
					});
					$('#loadingModal').modal('hide');
				}, loadDuration < 500 ? 500 - loadDuration : 100);
				console.log('Loaded in ' + loadDuration + 'ms');
			});
		});

	</script>
</body>
</html>