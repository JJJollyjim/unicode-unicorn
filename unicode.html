<html>
<head>
	<title>JS Unicode Thing</title>
	<script src="jquery-2.2.0.min.js"></script>
	<script src="data.js"></script>
	<script src="encode.js"></script>
	<script src="graphemes.js"></script>
	<style>
		.suggestion:hover {
			background-color: #dfd;
		}
		.deletion:hover {
			background-color: #fdd;
		}
		input[type=text] {
			width: 100%;
		}
		textarea {
			width: 100%;
			height: 300px;
			font-size: 30pt;
		}
		table {
			width: 100%;
			table-layout: fixed;
		}
		td {
			vertical-align: top;
		    -ms-word-break: break-all;
    		    word-break: break-all;

 /* Non standard for webkit */
     word-break: break-word;

    -webkit-hyphens: auto;
       -moz-hyphens: auto;
        -ms-hyphens: auto;
            hyphens: auto;
		}
	</style>
</head>
<body>
<table>
	<tr>
		<td>
			<p>
				<textarea id="output"></textarea>
			</p>
			<p id="info">
				String:
				<br>
				<div id="string"></div>
				<br>
				Extended grapheme clusters: <span id="extendedGraphemeClusters">0</span>
				<br>
				Legacy grapheme clusters: <span id="legacyGraphemeClusters">0</span>
				<br>
				Codepoints: <span id="numCodepoints">0</span>
				<br>
				UTF-16 code units: <span id="numUtf16CodeUnits">0</span>
				<br>
				UTF-8 code units: <span id="numUtf8CodeUnits">0</span>
				<br>
				Use this URL to share the unicode sequence: <a id="url"></a>
				<br>
				<p id="codepointlist"></p>
			</p>
			<p>
				<select id="byteOrderMark">
					<option>Use a byte order mark (U+FEFF)</option>
					<option selected="selected">Don't use a byte order mark</option>
				</select>
				<br>
				<select id="outputEncoding">
					<option>Unicode UTF-8</option>
					<option>Unicode UTF-16 (16-bit code units)</option>
					<option>Unicode UTF-16 BE (8-bit code units)</option>
					<option>Unicode UTF-16 LE (8-bit code units)</option>
					<option>Unicode UTF-32 (32-bit code units)</option>
					<option>Unicode UTF-32 BE (8-bit code units)</option>
					<option>Unicode UTF-32 LE (8-bit code units)</option>
				</select>
				<br>
				<select id="outputFormat">
					<option>Binary (Unpadded, Unprefixed)</option>
					<option>Binary (Padded, Unprefixed)</option>
					<option>Binary (Unpadded, Prefixed with '0b')</option>
					<option>Binary (Padded, Prefixed with '0b')</option>
					<option>Octal (Unprefixed)</option>
					<option>Octal (Prefixed with '0o')</option>
					<option>Octal (Prefixed with '0')</option>
					<option>Decimal</option>
					<option>Hexadecimal (Unpadded, Unprefixed)</option>
					<option>Hexadecimal (Unpadded, Prefixed with '0x')</option>
					<option>Hexadecimal (Unpadded, Prefixed with '0X')</option>
					<option>Hexadecimal (Unpadded, Prefixed with '\x')</option>
					<option>Hexadecimal (Unpadded, Prefixed with '\X')</option>
					<option>Hexadecimal (Unpadded, Prefixed with '\u')</option>
					<option>Hexadecimal (Unpadded, Prefixed with '\U')</option>
					<option>Hexadecimal (Unpadded, Prefixed with 'U+')</option>
					<option>Hexadecimal (Padded, Unprefixed)</option>
					<option selected="selected">Hexadecimal (Padded, Prefixed with '0x')</option>
					<option>Hexadecimal (Padded, Prefixed with '0X')</option>
					<option>Hexadecimal (Padded, Prefixed with '\x')</option>
					<option>Hexadecimal (Padded, Prefixed with '\X')</option>
					<option>Hexadecimal (Padded, Prefixed with '\u')</option>
					<option>Hexadecimal (Padded, Prefixed with '\U')</option>
					<option>Hexadecimal (Padded, Prefixed with 'U+')</option>
				</select>
				<br>
				<select id="outputJoiner">
					<option>Unseparated</option>
					<option>Space-separated</option>
					<option selected="selected">Comma-separated</option>
					<option>Linebreak-separated</option>
				</select>
			</p>
			<p>
				<code id="encodedOutput">
				</code>
			</p>
			<p>
				Unicode String Normalization:
				<br>
				<input type="button" onclick="normalizeString('NFD')" value="NFD (Normalization Form D: Canonical Decomposition)">
				<br>
				<input type="button" onclick="normalizeString('NFC')" value="NFC (Normalization Form C: Canonical Decomposition, followed by Canonical Composition)">
				<br>
				<input type="button" onclick="normalizeString('NFKD')" value="NFKD (Normalization Form KD: Compatibility Decomposition)">
				<br>
				<input type="button" onclick="normalizeString('NFKC')" value="NFKC (Normalization Form KC: Compatibility Decomposition, followed by Canonical Composition)">
			</p>
		</td>
		<td>
			<p>
				<input type="text" id="input" placeholder="Search for a character...">
			</p>
			<p>
				<div id="suggestions"></div>
			</p>
		</td>
	</tr>
</table>
<script>

function output(codepoint) {
	$('#output').val($('#output').val() + ctos([codepoint]));
	updateInfo();
}

$('#suggestions').on('click', '.suggestion', function(e) {
	var text = e.currentTarget.textContent;
	if (text.startsWith('U+')) {
		output(parseInt(text.replace('U+', '0x')));
	}
});

function updateSuggestions() {
	var input = $('#input').val();
	var suggestions = searchCodepoints(input);
	if (suggestions.length == 0) {
		$('#suggestions').html('');
		return;
	}
	if (suggestions.length >= 200)
		suggestions.push('...');
	for (var i in suggestions)
		suggestions[i] = escapeHtml(suggestions[i]);
	$('#suggestions').html('<div class="suggestion">' + suggestions.join('</div><div class="suggestion">') + '</div>');
}

function normalizeString(form) {
	if (!String.prototype.normalize) {
		alert('Your browser does not yet support string normalization');
		return;
	}
	$('#output').val($('#output').val().normalize(form));
	updateInfo();
}

function uiState() {
	return $('#output').val()
		+ $('#outputEncoding option:selected').text()
		+ $('#outputFormat option:selected').text()
		+ $('#outputJoiner option:selected').text()
		+ $('#byteOrderMark option:selected').text();
}

window.prevUIState = '';
function updateInfo() {
	var input = $('#output').val();
	if (uiState() == window.prevUIState)
		return;
	var codepoints = stoc(input);

	$('#extendedGraphemeClusters').text(countGraphemesForCodepoints(codepoints, true));
	$('#legacyGraphemeClusters').text(countGraphemesForCodepoints(codepoints, false));
	$('#numCodepoints').text(codepoints.length);
	$('#numUtf16CodeUnits').text(input.length);

	var numUtf8CodeUnits = 0;
	for (var i in codepoints) {
		var c = codepoints[i];
		if (c < 0x80)
			numUtf8CodeUnits += 1;
		else if (c < 0x800)
			numUtf8CodeUnits += 2;
		else if (c < 0x10000)
			numUtf8CodeUnits += 3;
		else if (c < 0x10FFFF)
			numUtf8CodeUnits += 4;
		else
			numUtf8CodeUnits = 0;
	}
	$('#numUtf8CodeUnits').text(numUtf8CodeUnits);
	$('#string').html(escapeHtml($('#output').val()).replace('\n', '<br>'));

	var codepointinfo = '';
	for (var i in codepoints) {
		codepointinfo += '<div class="deletion" onclick="deleteAtIndex(' + i + ');">';
		codepointinfo += escapeHtml(getUnicodeData(codepoints[i]));
		codepointinfo += '</div>';
	}
	$('#codepointlist').html(codepointinfo);

	var url = window.location.href.indexOf('?') == -1
		? window.location.href
		: window.location.href.substring(0, window.location.href.indexOf('?'));
	if (codepoints.length > 0)
		url += '?c=' + codepoints.join(',');
	$('#url').html(url.split('').join('&shy;')); // needed for the browser to not prefer word boundaries
	$('#url').attr('href', url);

	$('#encodedOutput').html(encodeOutput(
		$('#byteOrderMark option:selected').text(),
		$('#outputEncoding option:selected').text(),
		$('#outputFormat option:selected').text(),
		$('#outputJoiner option:selected').text(),
		codepoints
	));

	window.prevUIState = uiState();
}

function deleteAtIndex(index) {
	var input = $('#output').val();
	var codepoints = stoc(input);
	codepoints.splice(index, 1);
	var output = ctos(codepoints);
	$('#output').val(output);
	updateInfo();
}

var loaded = false;
$(document).ready(function() {
	if (loaded)
		return;
	loaded = true;
	var args = window.location.search.substring(1).split('&');
	for (var i in args) {
		var arg = args[i].split('=');
		if (arg[0] == 'c') {
			$('#output').val(ctos(arg[1].split(',')));
		}
	}
	initUnicodeData(function() {
		initGraphemeData(function() {
			updateInfo();
			updateSuggestions();
			$('#input').on('keyup', function(e) {
				if (e.keyCode == 13) {
					var input = $('#input').val();
					if (isNaN(parseInt(input.replace('U+', '0x')))) {
						document.body.style.backgroundColor = '#fdd';
						window.setTimeout(function() {
							document.body.style.backgroundColor = '#fff';
						}, 1000);
					} else {
						output(parseInt(input.replace('U+', '0x')));
						updateInfo();
						$('#input').val('');
					}
				}
				updateSuggestions();
			});
			$('#output').on('keyup', function() {
				updateInfo();
			});
			$('select').change(function() {
				updateInfo();
			});
			window.setInterval(function() {
				updateInfo();
			}, 1000);
		});
	});
});

</script>
</body>
</html>