<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<title>JS Unicode Thing</title>

	<link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/stylesheet.css" rel="stylesheet">
</head>
<body>
	<script src="libs/jquery-2.2.0.min.js"></script>
	<script src="libs/bootstrap/js/bootstrap.min.js"></script>
	<script src="libs/he.js"></script>
	<script src="libs/punycode.min.js"></script>
	<script src="libs/randomColor.js"></script>
	<script src="libs/utf8.js"></script>

	<script src="js/ajax.js"></script>
	<script src="js/blocks.js"></script>
	<script src="js/data.js"></script>
	<script src="js/encode.js"></script>
	<script src="js/graphemes.js"></script>
	<script src="js/han.js"></script>
	<script src="js/languages.js"></script>
	<script src="js/search.js"></script>
	<script src="js/ui.js"></script>

	<div style="width: 100%; height: 30px; position: fixed; background-color: white"></div>
	<div style="padding: 15px">
		<div class="fixed" data-spacer-id="nav-spacer">
			<p>
				<textarea id="output"></textarea>
			</p>

			<!-- Nav tabs -->
			<ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active">
					<a href="#search" aria-controls="search" role="tab" data-toggle="tab">Search and Insert</a>
				</li>
				<li role="presentation">
					<a href="#stats" aria-controls="stats" role="tab" data-toggle="tab">Text Info</a>
				</li>
				<li role="presentation">
					<a href="#codepoints" aria-controls="codepoints" role="tab" data-toggle="tab">List of Codepoints</a>
				</li>
				<li role="presentation">
					<a href="#encode" aria-controls="encode" role="tab" data-toggle="tab">Encodings</a>
				</li>
				<li role="presentation">
					<a href="#normalization" aria-controls="normalization" role="tab" data-toggle="tab">Unicode Normalization</a>
				</li>
				<li role="presentation">
					<a href="#codepages" aria-controls="codepages" role="tab" data-toggle="tab">View Codepages</a>
				</li>
				<li role="presentation">
					<a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Help &amp; Settings</a>
				</li>
			</ul>
		</div>

		<div id="nav-spacer" class="spacer"></div>

		<!-- Tab panes -->
		<div class="tab-content">
			<div role="tabpanel" class="tab-pane active" id="search">
				<div class="fixed" data-spacer-id="input-spacer">
					<input type="text" id="input" placeholder="Search for a character... (use commas to separate terms)">
				</div>
				<div id="input-spacer" class="spacer"></div>
				<table class="table table-striped" id="searchResults"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="stats">
				<p>
					String:
				</p>
				<div id="string"></div>
				<p>
					<br>
					Extended grapheme clusters: <span id="extendedGraphemeClusters">0</span>
					<br>
					Legacy grapheme clusters: <span id="legacyGraphemeClusters">0</span>
					<br>
					Codepoints: <span id="numCodepoints">0</span>
					<br>
					UTF-16 code units: <span id="numUtf16CodeUnits">0</span>
					<br>
					UTF-16 bytes: <span id="numUtf16Bytes">0</span>
					<br>
					UTF-8 code units/bytes: <span id="numUtf8CodeUnits">0</span>
				</p>
				<p>
					Use this URL to share the unicode sequence: <a id="url" style="word-break: break-all;"></a>
				</p>
			</div>
			<div role="tabpanel" class="tab-pane" id="codepoints">
				<table id="codepointlist" class="table table-striped"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="encode">
				<p>
					<select id="byteOrderMark">
						<option>Use a byte order mark (U+FEFF)</option>
						<option selected="selected">Don't use a byte order mark</option>
					</select>
					<br>
					<select id="outputEncoding">
					</select>
					<br>
					<select id="outputFormat">
						<option>Binary (Unpadded, Unprefixed)</option>
						<option>Binary (Padded, Unprefixed)</option>
						<option>Binary (Unpadded, Prefixed with '0b')</option>
						<option>Binary (Padded, Prefixed with '0b')</option>
						<option>Binary (Unpadded, Prefixed with '\b')</option>
						<option>Binary (Padded, Prefixed with '\b')</option>
						<option>Octal (Unprefixed)</option>
						<option>Octal (Prefixed with '0o')</option>
						<option>Octal (Prefixed with '0')</option>
						<option>Octal (Prefixed with '\o')</option>
						<option>Decimal</option>
						<option>Hexadecimal (Unpadded, Unprefixed)</option>
						<option>Hexadecimal (Unpadded, Prefixed with '0x')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '0X')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\x')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\X')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\u')</option>
						<option>Hexadecimal (Unpadded, Prefixed with '\U')</option>
						<option>Hexadecimal (Unpadded, Prefixed with 'U+')</option>
						<option>Hexadecimal (Padded, Unprefixed)</option>
						<option selected="selected">Hexadecimal (Padded, Prefixed with '0x')</option>
						<option>Hexadecimal (Padded, Prefixed with '0X')</option>
						<option>Hexadecimal (Padded, Prefixed with '\x')</option>
						<option>Hexadecimal (Padded, Prefixed with '\X')</option>
						<option>Hexadecimal (Padded, Prefixed with '\u')</option>
						<option>Hexadecimal (Padded, Prefixed with '\U')</option>
						<option>Hexadecimal (Padded, Prefixed with 'U+')</option>
					</select>
					<br>
					<select id="outputJoiner">
						<option>Unseparated</option>
						<option>Separated using spaces</option>
						<option>Separated using commas</option>
						<option selected="selected">Separated using commas and spaces</option>
						<option>Separated using semicolons</option>
						<option>Separated using semicolons and spaces</option>
						<option>Separated using linebreaks</option>
						<option>Separated using commas and linebreaks</option>
					</select>
				</p>
				<pre id="encodedOutput"></pre>
				<textarea id="encodedInput" placeholder="Input to decode using above settings"></textarea>
				<table class="table table-striped" id="decodedCodepoints"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="normalization">
				<p>
					Click on one of these buttons to perform Unicode normalization on the string:
					<br>
					<br>
					<input type="button" onclick="normalizeString('NFD')" value="NFD (Normalization Form D: Canonical Decomposition)">
					<br>
					<input type="button" onclick="normalizeString('NFC')" value="NFC (Normalization Form C: Canonical Decomposition, followed by Canonical Composition)">
					<br>
					<input type="button" onclick="normalizeString('NFKD')" value="NFKD (Normalization Form KD: Compatibility Decomposition)">
					<br>
					<input type="button" onclick="normalizeString('NFKC')" value="NFKC (Normalization Form KC: Compatibility Decomposition, followed by Canonical Composition)">
				</p>
			</div>
			<div role="tabpanel" class="tab-pane" id="codepages">
				<select id="codepageEncoding">
				</select>
				<table class="table" id="codepage"></table>
			</div>
			<div role="tabpanel" class="tab-pane" id="settings">
				<p>
					<b>Search syntax:</b><br>
					Use commas to separate multiple terms.<br>
					All searches are case-insensitive.<br>
					By default, all visible character properties are searched, but you can use this syntax to search for specific character properties:
					<pre>
						U+FF
						cp:100
						name:Latin capital letter a
						block:Hiragana
						script:Han
						category:currency symbol
						alias:Byte order mark
						meaning:Water
						kun:mizu
						on:sui
						mandarin:shu«ê
					</pre>
				</p>
				<p>
					The shapes of some characters may change depending on your browser's language. For example, Han characters have different shapes in Chinese and Japanese. You can overwrite your browser's language by choosing the correct language settings here. Alternatively, you can type a valid language code into the textbox below. See <a target="_blank" href="https://www.w3.org/International/articles/language-tags/">here</a> for more information.<br>
					Language: <select id="languageList"></select><br>
					Script: <select id="scriptList"></select><br>
					Region: <select id="regionList"></select><br>
					Variant: <select id="variantList"></select><br>
					Code: <input type="text" id="languageCode" placeholder="Language code (e.g. en, en-US, zh-Hant)">
				</p>
				<p>
					<a onclick="$('#licenses-modal').modal('show');" style="cursor: pointer;">Third-Party Licenses</a>
				</p>
			</div>
		</div>
	</div>
	<div class="modal fade" data-backdrop="static" data-keyboard="false" id="loadingModal" role="dialog">
		<div style="height: 20%">
		</div>
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Loading Unicode Data Files...</h4>
				</div>
				<div class="modal-body">
					<p>This may take a few seconds.</p>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="codepoint-detail" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Info for codepoint U+<span id="detail-codepoint-hex">0000</span> (Decimal: <span id="detail-codepoint-decimal"></span>)</h4>
				</div>
				<div class="modal-body">
					<p>Name: <span id="detail-name"></span></p>
					<p>Character: <span id="detail-character"></span></p>
					<p>General Character Category: <span id="detail-category"></span></p>
					<p>Block: <span id="detail-block"></span></p>
					<p>Script: <span id="detail-script"></span></p>
					<p id="detail-aliases">Aliases: <span id="detail-aliases-list"></span></p>
					<p id="detail-meaning">Meaning: <span id="detail-meaning-content"></span></p>
					<p id="detail-mandarin">Mandarin: <span id="detail-mandarin-content"></span></p>
					<p id="detail-kun">Kun: <span id="detail-kun-content"></span></p>
					<p id="detail-on">On: <span id="detail-on-content"></span></p>
					<pre id="detail-encoding-outputs"></pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="licenses-modal" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Third-Party Licenses</h4>
				</div>
				<div class="modal-body">
					<pre id="licenses-text">
					</pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		function output(codepoint) {
			$('#output').val($('#output').val() + ctos([codepoint]));
			updateInfo();
		}

		function updateSuggestions() {
			var input = $('#input').val();
			var results = searchCodepoints(input);
			renderCodepointsInTable(
				results,
				'searchResults',
				[{displayName: 'Insert', functionName: 'output'}]
			);
		}

		function normalizeString(form) {
			if (!String.prototype.normalize) {
				alert('Your browser currently does not support string normalization.');
				return;
			}
			$('#output').val($('#output').val().normalize(form));
			updateInfo();
		}

		function uiState() {
			return $('#output').val()
				+ $('#encodedInput').val()
				+ $('#languageCode').val()
				+ $('#outputEncoding option:selected').text()
				+ $('#outputFormat option:selected').text()
				+ $('#outputJoiner option:selected').text()
				+ $('#byteOrderMark option:selected').text()
				+ $('#codepageEncoding option:selected').text()
				+ $('#languageList option:selected').text()
				+ $('#scriptList option:selected').text()
				+ $('#regionList option:selected').text()
				+ $('#variantList option:selected').text();
		}

		prevUIState = '';
		function updateInfo() {
			var input = $('#output').val();
			if (uiState() == prevUIState)
				return;

			var codepoints = stoc(input);

			updateRenderedCodepage();

			$('#extendedGraphemeClusters').text(countGraphemesForCodepoints(codepoints, true));
			$('#legacyGraphemeClusters').text(countGraphemesForCodepoints(codepoints, false));
			$('#numCodepoints').text(codepoints.length);
			$('#numUtf16CodeUnits').text(input.length);
			$('#numUtf16Bytes').text(input.length * 2);

			var numUtf8CodeUnits = 0;
			for (var i = 0; i < codepoints.length; ++i) {
				var c = codepoints[i];
				if (c < 0x80)
					numUtf8CodeUnits += 1;
				else if (c < 0x800)
					numUtf8CodeUnits += 2;
				else if (c < 0x10000)
					numUtf8CodeUnits += 3;
				else if (c < 0x10FFFF)
					numUtf8CodeUnits += 4;
				else
					numUtf8CodeUnits = 0;
			}
			$('#numUtf8CodeUnits').text(numUtf8CodeUnits);
			$('#numUtf8Bytes').text(numUtf8CodeUnits);
			$('#string').html(escapeHtml($('#output').val()).replace(/\n/g, '<br>'));

			renderCodepointsInTable(codepoints, 'codepointlist', [{
				displayName: 'Delete',
				functionName: 'deleteAtIndex'
			}, {
				displayName: 'Move up',
				functionName: 'moveUp',
				require: function(i, length) { return i != 0; }
			}, {
				displayName: 'Move down',
				functionName: 'moveDown',
				require: function(i, length) { return i != length - 1; }
			}]);

			var url = location.href.indexOf('?') == -1
				? location.href
				: location.href.substring(0, location.href.indexOf('?'));
			if (codepoints.length > 0)
				url += '?c=' + codepoints.join(',');
			$('#url').text(url);
			$('#url').attr('href', url);

			$('#encodedOutput').html(encodeOutput(
				$('#byteOrderMark option:selected').text(),
				$('#outputEncoding option:selected').text(),
				$('#outputFormat option:selected').text(),
				$('#outputJoiner option:selected').text(),
				codepoints
			));

			var decodedOutput = decodeOutput(
				$('#byteOrderMark option:selected').text(),
				$('#outputEncoding option:selected').text(),
				$('#outputFormat option:selected').text(),
				$('#outputJoiner option:selected').text(),
				$('#encodedInput').val()
			);
			if (decodedOutput)
				renderCodepointsInTable(
					decodedOutput,
					'decodedCodepoints',
					[{displayName: 'Insert', functionName: 'output'}]);

			var lang = '';
			var textboxCode = $('#languageCode').val();
			var dropdownCode = '';
			var langComponentStrings = [
				$('#languageList option:selected').attr('data-code'),
				$('#scriptList option:selected').attr('data-code'),
				$('#regionList option:selected').attr('data-code'),
				$('#variantList option:selected').attr('data-code')
			];
			for (var i = 0; i < langComponentStrings.length; ++i) {
				var component = langComponentStrings[i];
				if (!component)
					continue;
				if (dropdownCode != '')
					dropdownCode += '-';
				dropdownCode += component;
			}
			// valid states:
			//   everything enabled, textboxCode and dropdownCode empty
			//   dropdownCode non-empty: textboxCode set to dropdownCode, textbox disabled
			//   dropdownCode empty: dropdown disabled

			if ($('#languageCode')[0].hasAttribute('disabled')) {
				$('#languageCode').val(''); // occurs when dropdownCode is reset to blank
			}
				
			if (textboxCode == '' && dropdownCode == '') {
				$('#languageCode').removeAttr('disabled');
				$('#languageList').removeAttr('disabled');
				$('#scriptList').removeAttr('disabled');
				$('#regionList').removeAttr('disabled');
				$('#variantList').removeAttr('disabled');
				lang = '';
			} else if (textboxCode == '' && dropdownCode != '') {
				$('#languageCode').attr('disabled', 'disabled');
				$('#languageList').removeAttr('disabled');
				$('#scriptList').removeAttr('disabled');
				$('#regionList').removeAttr('disabled');
				$('#variantList').removeAttr('disabled');
				lang = dropdownCode;
				$('#languageCode').val(lang);
			} else if (textboxCode != '' && dropdownCode == '') {
				$('#languageCode').removeAttr('disabled');
				$('#languageList').attr('disabled', 'disabled');
				$('#scriptList').attr('disabled', 'disabled');
				$('#regionList').attr('disabled', 'disabled');
				$('#variantList').attr('disabled', 'disabled');
				lang = textboxCode;
			} else {
				if ($('#languageCode')[0].hasAttribute('disabled')) {
					lang = dropdownCode;
					$('#languageCode').val(lang);
				} else {
					lang = textboxCode;
				}
			}
			
			$('html').attr('lang', lang);
			$('html').attr('xml:lang', lang);

			prevUIState = uiState();
		}

		function deleteAtIndex(codepoint, index) {
			var input = $('#output').val();
			var codepoints = stoc(input);
			codepoints.splice(index, 1);
			var output = ctos(codepoints);
			$('#output').val(output);
			updateInfo();
		}

		function moveUp(codepoint, index) {
			var input = $('#output').val();
			var codepoints = stoc(input);
			var c = codepoints[index];
			codepoints[index] = codepoints[index-1];
			codepoints[index-1] = c;
			var output = ctos(codepoints);
			$('#output').val(output);
			updateInfo();
		}

		function moveDown(codepoint, index) {
			var input = $('#output').val();
			var codepoints = stoc(input);
			var c = codepoints[index];
			codepoints[index] = codepoints[index+1];
			codepoints[index+1] = c;
			var output = ctos(codepoints);
			$('#output').val(output);
			updateInfo();
		}

		function initLicenseInfo(completion) {
			requestAsync('licenses.html', function(lines) {
				$('#licenses-text').html(lines.join('\n'));
				completion();
			});
		}

		function initData(completion) {
			callMultipleAsync([
				initializeMappings,
				initHanData,
				initGraphemeData,
				initUnicodeData,
				initGeneralCategoryNames,
				initAliasData,
				initBlockData,
				initHangulSyllableTypes,
				initShortJamoNames,
				initScriptData,
				initLicenseInfo,
				initLanguageData], completion);
		}

		function updateSpacerHeights() {
			$('.fixed').each(function(i, e) {
				var spacerId = $(e).attr('data-spacer-id');
				var spacer = $('#' + spacerId);
				if (spacer.attr('data-extra-height'))
					var extraHeight = parseFloat($(spacer).attr('data-extra-height'));
				else
					var extraHeight = 0;
				spacer.height($(e).height() + extraHeight);
			});
		}

		var loaded = false;
		$(document).ready(function() {
			if (loaded)
				return;
			loaded = true;
			var args = location.search.substring(1).split('&');
			for (var i = 0; i < args.length; ++i) {
				var arg = args[i].split('=');
				if (arg[0] == 'c') {
					$('#output').val(ctos(arg[1].split(',')));
				}
			}
			$('#loadingModal').modal('show');
			updateSpacerHeights();
			var startTime = new Date();
			initData(function() {
				initializeSearchStrings();
				var loadDuration = new Date() - startTime; // in ms
				setTimeout(function() {
					updateInfo();
					updateSuggestions();
					$('#input').on('keyup', function(e) {
						if (e.keyCode == 13) {
							var input = $('#input').val();
							if (isNaN(parseInt(input.replace('U+', '0x')))) {
								document.body.style.backgroundColor = '#fdd';
								setTimeout(function() {
									document.body.style.backgroundColor = '#fff';
								}, 1000);
							} else {
								output(parseInt(input.replace('U+', '0x')));
								updateInfo();
								$('#input').val('');
							}
						}
						updateSuggestions();
					});
					$('#output').on('keyup', function() {
						updateInfo();
					});
					$('select').change(function() {
						updateInfo();
					});
					setInterval(function() {
						updateInfo();
						updateSpacerHeights();
					}, 1000);
					$('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
						updateSpacerHeights();
					});
					$('#loadingModal').modal('hide');
				}, loadDuration < 500 ? 500 - loadDuration : 100);
				console.log('Loaded in ' + loadDuration + 'ms');
			});
		});

	</script>
</body>
</html>